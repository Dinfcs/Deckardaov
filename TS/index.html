<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turn on Cyborg Projects</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Estilos base */
        body { background-color: #121418; font-family: 'Inter', system-ui, -apple-system, sans-serif; color: #e2e8f0; margin: 0; height: 100vh; overflow: auto; }
        .main-container { max-width: 100%; min-height: 100vh; margin: 0; padding: 0.75rem; display: flex; flex-direction: column; }
        .filters-container { padding: 0.5rem 0; margin-bottom: 0.75rem; }
        .search-container { background-color: #1a1d24; border-radius: 0.5rem; padding: 0.75rem; display: flex; gap: 0.75rem; border: 1px solid #30363d; align-items: center; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #30363d; border-radius: 0.375rem; background-color: #252830; font-size: 0.85rem; color: #e2e8f0; }
        .content-container { display: flex; gap: 1rem; flex: 1; min-height: 500px; margin-bottom: 1rem; }
        .form-section { width: 30%; min-width: 300px; display: flex; flex-direction: column; }
        .output-section { width: 70%; display: flex; flex-direction: column; }
        .form-container, .output-container { background-color: #1a1d24; border-radius: 0.5rem; padding: 1rem; border: 1px solid #30363d; position: relative; margin-bottom: 1rem; flex: 1; }
        .output-pre { flex: 1; min-height: 300px; background-color: #1e2029; border-radius: 0.375rem; padding: 0.75rem; overflow-y: auto; font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; font-size: 0.85rem; color: #c9d1d9; border: 1px solid #30363d; }
        .table-container { width: 100%; background-color: #1a1d24; border-radius: 0.5rem; border: 1px solid #30363d; overflow: hidden; display: flex; flex-direction: column; }
        .table-data-container { flex: 1; overflow-y: auto; padding: 0 0.25rem; max-height: 250px; }
        .logo-input-container { position: relative; width: 100%; }
        #logoPreview { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; background-color: #252830; border: 1px solid #4b5563; border-radius: 4px; object-fit: contain; display: none; cursor: pointer; }
        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; margin-bottom: 0.35rem; font-weight: 500; color: #a0aec0; font-size: 0.85rem; }
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid #30363d; border-radius: 0.375rem; background-color: #252830; font-size: 0.85rem; color: #e2e8f0; }
        #logoUrl.input-field { padding-right: 42px; }
        .checkbox-group { display: flex; align-items: center; margin-bottom: 0.75rem; font-size: 0.85rem; color: #a0aec0; }
        .checkbox-group input { margin-right: 0.5rem; accent-color: #6366f1; }
        .copy-btn { padding: 0.35rem 0.6rem; background-color: #0ea5e9; color: white; border-radius: 0.375rem; font-size: 0.8rem; cursor: pointer; margin-bottom: 0.5rem; }
        .btn { padding: 0.5rem 0.75rem; font-size: 0.85rem; cursor: pointer; border-radius: 0.375rem; background-color: #6366f1; color: white; border: none; }
        table { width: 100%; border-collapse: separate; font-size: 0.85rem; }
        th, td { padding: 0.6rem; text-align: left; border-bottom: 1px solid #30363d; }
        th { background-color: #252830; position: sticky; top: 0; }
        #notificacion { position: fixed; bottom: 1.5rem; right: 1.5rem; background-color: #059669; color: white; padding: 0.6rem 1rem; border-radius: 0.375rem; display: none; z-index: 1000; }
    </style>
</head>
<body>
    <div class="filters-container">
        <div class="search-container">
            <div class="search-split-container">
                <input type="text" id="buscarSplit" class="search-input" placeholder="Ej: UT - City of Cottonwood Heights" oninput="autoSplitSearch()">
            </div>
            <input type="text" id="buscar1" class="search-input" placeholder="Filtro 1" oninput="filtrarTabla()">
            <input type="text" id="buscar2" class="search-input" placeholder="Filtro 2" oninput="filtrarTabla()">
            <button class="btn" style="background-color: #ff9900;" onclick="window.open('https://webapp-8ba8c4de11154ee89.transfer-webapp.us-west-2.on.aws/', '_blank')">S3</button>
        </div>
        
        <div class="table-container">
            <div id="loader" style="display:none; text-align:center; padding:10px;">Cargando...</div>
            <div class="table-data-container" id="tabla-container"></div>
            <div class="pagination" id="paginacion" style="display:flex; justify-content:center; gap:10px; padding:10px;"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="content-container">
            <div class="form-section">
                <div class="form-container">
                    <h2>Requirements</h2>
        
                    <div class="input-group">
                        <label for="logoUrl" class="input-label">Logo Link</label>
                        <div class="logo-input-container">
                            <input type="text" id="logoUrl" class="input-field" oninput="generateConfig()" required>
                            <img id="logoPreview" src="" alt="Logo Preview">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="placeKey" class="input-label">Place Key</label>
                        <input type="text" id="placeKey" class="input-field" oninput="autoFillFields(); generateConfig()" required>
                    </div>
        
                    <div class="input-group">
                        <label for="state" class="input-label">State</label>
                        <input type="text" id="state" class="input-field" readonly>
                    </div>
                    <div class="input-group">
                        <label for="county" class="input-label">County</label>
                        <input type="text" id="county" class="input-field" readonly>
                    </div>
                    <div class="input-group">
                        <label for="city" class="input-label">City</label>
                        <input type="text" id="city" class="input-field" readonly>
                    </div>
        
                    <div class="input-group">
                        <label id="nsLabel" for="placens" class="input-label">Code (8 digits)</label>
                        <input type="text" id="placens" class="input-field" oninput="generateConfig()" required pattern="[0-9]{8}">
                    </div>
        
                    <div class="input-group">
                        <label for="days" class="input-label">Rental days</label>
                        <input type="number" id="days" class="input-field" value="30" oninput="generateConfig()">
                    </div>
                    
                    <div class="checkbox-group"><input type="checkbox" id="enableNotes" checked onchange="generateConfig()"><label>Enable Notes</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="showSuggestions" checked onchange="generateConfig()"><label>Enable suggestions</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="pdf" checked onchange="generateConfig()"><label>Enable PDF scraping</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="warmCache" checked onchange="generateConfig()"><label>Enable Cache Warm-up</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="includeCities" onchange="generateConfig()"><label>Include cities</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="enablePropertyDetails" onchange="generateConfig()"><label>Is HdL/Rivertree/Azavar</label></div>
                </div>
            </div>

            <div class="output-section">
                <div class="output-container">
                    <h3>YAML Generated:</h3>
                    <button class="copy-btn" onclick="copiarYAML()">COPY YAML</button>
                    <pre id="output" class="output-pre"></pre>
                </div>
            </div>
        </div>
    </div>

    <div id="notificacion">Copiado</div>

    <script>
        const S3_BASE_URL = "https://rentalscape-assets-prod-usw2.s3.us-west-2.amazonaws.com/customer_logos/";

        function capitalize(str) { 
            return str.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()); 
        }

        function autoFillFields() {
            const placeKey = document.getElementById("placeKey").value.trim().toLowerCase();
            const parts = placeKey.split("-");
            if (parts.length >= 2) {
                document.getElementById("state").value = parts[0].toUpperCase();
                document.getElementById("county").value = capitalize(parts[1]);
                document.getElementById("city").value = parts.length >= 3 ? capitalize(parts.slice(2).join("-").replace("city of ", "")) : "";
            }
        }

        function generateConfig() {
            const placeKey = document.getElementById("placeKey").value.trim().toLowerCase();
            const state = document.getElementById("state").value.trim();
            const logoUrl = document.getElementById("logoUrl").value.trim();
            const nsInput = document.getElementById("placens");
            const nsField = nsInput.dataset.currentId || "placens";
            const days = parseInt(document.getElementById("days").value) || 30;
            const nights = days - 1;

            if (!placeKey) { document.getElementById("output").textContent = ""; return; }

            let placeName = "";
            if (filaSeleccionada !== null) {
                const fila = datosFiltrados[filaSeleccionada];
                let rawName = fila['string_name'] || fila['String_name'] || fila['string name'] || "";
                placeName = rawName.includes(',') ? rawName : `${rawName}, ${state}`;
            }

            let yaml = `logo: ${logoUrl}\n`;
            yaml += `modules:\n`;
            yaml += `  notes:\n`;
            yaml += `    mode: ${document.getElementById("enableNotes").checked ? "enabled" : "disabled"}\n`;
            yaml += `    read:\n      - admin\n      - ${placeKey}\n`;
            yaml += `    rw:\n      - ${placeKey}\n`;
            yaml += `  rentalscape:\n`;

            if (document.getElementById("enablePropertyDetails").checked) {
                yaml += `    propertyDetails:\n      tabs:\n        activity:\n          enabled: true\n        history:\n          enabled: true\n        license:\n          enabled: false\n`;
            }

            if (document.getElementById("includeCities").checked) yaml += `    includeCities: true\n`;
            yaml += `    licenseEditMode: rs_on_page\n`;
            yaml += `    emailCcDeckard: Rentalscape Support <rentalscape@deckard.com>\n`;
            yaml += `    propertySummaryMode: IDENTIFIED\n`;
            yaml += `    production:\n      warm: ${document.getElementById("warmCache").checked}\n`;
            yaml += `    rentalPeriod:\n      days: ${days}\n`;
            yaml += `    rentalTypes:\n      current: Current STR (${nights} nights or less)\n      hotel: Hotel/Timeshare\n      ltr: Long Term Rental\n      other: Other Rental\n      previous: Previously an STR\n      unavailable: Unavailable\n`;
            
            if (document.getElementById("showSuggestions").checked) yaml += `    showSuggestions: true\n`;
            
            yaml += `name: ${placeName}\n`;
            yaml += `pdf: ${document.getElementById("pdf").checked}\n`;
            yaml += `${nsField}: '${nsInput.value.trim()}'`; // Quitamos los \n de aquí

            // Procesamos y forzamos exactamente UN salto de línea al final
            const cleanedYaml = yaml.split('\n')
                .map(l => l.trimEnd())
                .join('\n')
                .trimEnd() + "\n"; 

            document.getElementById("output").textContent = cleanedYaml;
            
            const preview = document.getElementById("logoPreview");
            if (logoUrl) { preview.src = logoUrl; preview.style.display = "block"; }
            else { preview.style.display = "none"; }
        }

        function seleccionarFila(index) {
            filaSeleccionada = index;
            const fila = datosFiltrados[index];
            if (!fila) return;

            // 1. Place Name para el Logo Link (Literal como viene en la tabla)
            const rawPlaceNameFromTable = fila['place_name'] || fila['Place_name'] || fila['Place Name'] || "";
            
            // 2. Rellenar Logo Link con el valor exacto solicitado
            document.getElementById("logoUrl").value = S3_BASE_URL + rawPlaceNameFromTable + ".png";

            // 3. Place Key para los otros campos
            document.getElementById("placeKey").value = rawPlaceNameFromTable;
            autoFillFields();

            // 4. NS Logic
            const nsInput = document.getElementById("placens");
            const nsLabel = document.getElementById("nsLabel");
            const type = (fila['place'] || "").toLowerCase();
            
            if (type === 'county') { nsLabel.textContent = "CountyNS"; nsInput.dataset.currentId = "countyns"; }
            else if (type === 'cousub') { nsLabel.textContent = "CousubNS"; nsInput.dataset.currentId = "cousubns"; }
            else { nsLabel.textContent = "PlaceNS"; nsInput.dataset.currentId = "placens"; }
            
            nsInput.value = fila['code'] || fila['Code'] || fila['place_code'] || "";

            actualizarTabla();
            generateConfig();
        }

        // --- FUNCIONES DE TABLA ---
        let datosCompletos = [], datosFiltrados = [], encabezados = [], filaSeleccionada = null;
        let paginaActual = 1, filasPorPagina = 5;

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("loader").style.display = "block";
            fetch("https://dinfcs.github.io/Deckardaov/TS/datos_exportados.json")
                .then(r => r.json()).then(d => {
                    document.getElementById("loader").style.display = "none";
                    encabezados = d[0];
                    datosCompletos = d.slice(1).map(f => {
                        let o = {}; encabezados.forEach((c, i) => o[c] = f[i] || ""); return o;
                    });
                    datosFiltrados = [...datosCompletos];
                    actualizarTabla();
                });
        });

        function filtrarTabla() {
            const f1 = document.getElementById("buscar1").value.toLowerCase();
            const f2 = document.getElementById("buscar2").value.toLowerCase();
            datosFiltrados = datosCompletos.filter(f => 
                (f1 === "" || Object.values(f).some(v => v.toString().toLowerCase().includes(f1))) &&
                (f2 === "" || Object.values(f).some(v => v.toString().toLowerCase().includes(f2)))
            );
            if (datosFiltrados.length === 1) seleccionarFila(0);
            else filaSeleccionada = null;
            paginaActual = 1;
            actualizarTabla();
        }

        function actualizarTabla() {
            let inicio = (paginaActual - 1) * filasPorPagina;
            let paged = datosFiltrados.slice(inicio, inicio + filasPorPagina);
            let h = "<table><tr><th>Sel</th>" + encabezados.map(e => `<th>${e}</th>`).join("") + "</tr>";
            paged.forEach((f, i) => {
                const isSel = filaSeleccionada !== null && datosFiltrados[filaSeleccionada] === f;
                h += `<tr style="${isSel ? 'background:#3b82f6' : ''}">
                    <td><input type="radio" name="sel" ${isSel ? 'checked' : ''} onclick="seleccionarFila(${inicio + i})"></td>
                    ${encabezados.map(e => `<td>${f[e]}</td>`).join("")}</tr>`;
            });
            document.getElementById("tabla-container").innerHTML = h + "</table>";
            actualizarPaginacion();
        }

        function actualizarPaginacion() {
            let total = Math.ceil(datosFiltrados.length / filasPorPagina);
            document.getElementById("paginacion").innerHTML = total > 1 ? 
                `<button onclick="cambiarPagina(-1)">⬅️</button> ${paginaActual}/${total} <button onclick="cambiarPagina(1)">➡️</button>` : "";
        }

        function cambiarPagina(d) { paginaActual += d; actualizarTabla(); }

        function autoSplitSearch() {
            const v = document.getElementById("buscarSplit").value;
            if (v.includes("-")) {
                const [p1, p2] = v.split("-").map(s => s.trim());
                document.getElementById("buscar1").value = p1;
                document.getElementById("buscar2").value = p2;
                filtrarTabla();
            }
        }

        function copiarYAML() {
            navigator.clipboard.writeText(document.getElementById("output").textContent);
            const n = document.getElementById("notificacion");
            n.style.display = "block"; setTimeout(() => n.style.display = "none", 2000);
        }

        document.getElementById("logoPreview").onclick = function() {
            const img = document.createElement("img");
            img.src = this.src;
            const div = document.createElement("div");
            div.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:9999;";
            img.style = "max-width:90%;max-height:90%;border:5px solid white;";
            div.appendChild(img);
            div.onclick = () => div.remove();
            document.body.appendChild(div);
        };
    </script>
</body>
</html>
